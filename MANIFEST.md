<!— MANIFEST.md —>

# keep-backup — MANIFEST

## 0. この文書の役割
- このリポジトリの判断基準（憲法）
- 迷ったらここに戻る
- 実装の手順や運用ルールは `AGENTS.md` に書く（ここでは書かない）
- 最終決定は人間（でーはん）が行う

—

## 1. 目的（Why）
Google Keep のノートを、誤操作や障害により「まとめて消える」事態に備えて、手元に退避・保管できるようにする。  
現段階の主目的は **確実に保管できること**。

—

## 2. 非目的（やらないこと）
- Keep への自動復元（Phase 1 の要件ではない）
- 自動ログイン（2FA/トークン管理をコードに持ち込まない）
- 添付（画像/音声/手書き等）の完全対応（後回し）
- 完璧な同期や差分バックアップ（フルのみ）
- 1ファイルに何でも詰め込むドキュメント構成（目的別に分ける）

—

## 3. 前提・制約（Constraints）
- 実行環境は Windows + WSL(Ubuntu) + Docker
- 実装言語は Python（Playwright を使用）
- 実行は手動（週1想定）。将来的に定期実行は検討
- CI での取り回しを最優先し、stdout の最小要約を CI がそのまま利用する
- 認証は「ログイン済みブラウザプロファイル」を前提にする（運用で解決）
- 出力は WSL 側のプロジェクトディレクトリ配下へ保存する
- 暗号化は当面必須にしない（ただし保存先の運用でカバー）

—

## 4. スコープ（What）— Must / Should / Could
### Must（Phase 1 で必ず取る）
- ノート本文（テキスト）
- 最小メタ情報（識別用に最低限）
  - 例：タイトル相当、更新日時相当、ノートID相当のうち取れるもの
- フルバックアップ（対象範囲に含まれる**全ノート**を毎回すべて）

### Should（Phase 1 で狙う）
- アーカイブのノート
- ゴミ箱（削除済み）のノート

### Could（後回し）
- チェックリスト構造、ラベル、色、リマインダー、共同編集など
- 添付（画像・音声・手書き等）
- Google Docs 出力（Phase 2 以降）

—

## 5. 出力（Format）と保存（Storage）
- 正：JSON（構造化データ）
- 任意：HTML（閲覧用）は後付け可
- 出力先（固定）
  - `backups/YYYY-MM-DD/keep.json`
  - `logs/run_YYYY-MM-DD_HHMMSS.log`
- 保持（暫定）
  - 直近8世代保持を基本とする（自動化は段階的に）

—

## 6. 成功条件（Done）
### Phase 1（ローカル保管MVP）
- Windows で `backup_keep.bat` をダブルクリックして開始できる
- 1回の実行で `backups/YYYY-MM-DD/keep.json` が生成される
- ログに「成功/失敗・取得件数・出力先・所要時間」が残る
- stdout に「成功/失敗・取得件数・出力先・所要時間」の最小要約が出力される
- 一部の取得エラーがあっても、全体として成果物が残る

### Phase 2（将来）
- 定期実行（cron/タスクスケジューラ等）
- Google Docs（実行日ごとに新規 1ファイル）への出力
- 形式変換や復元支援の強化

—

## 7. 最短成功パス（最初に必ず通す入口）
- 「薄い縦切り」を先に通す  
  - 画面に見える範囲のノート本文を少数取得できればOK
- それが通った後、「標準的な縦切り」に厚くする  
  - 全件 + 通常/アーカイブ/ゴミ箱

> 縦切りの詳細は `docs/vertical-slice-*.md` を正とする。

—

## 8. 品質の優先順位
1. 壊れにくさ（堅牢性）
2. 再現性（同じ入口で同じ結果に近づく）
3. 追跡可能性（ログと証跡）
4. 網羅性（全件・状態別）
5. 便利機能（HTML、Docs、差分など）

—

## 9. リスクと方針
- Keep のUI変更でスクレイピングが壊れる
  - 方針：ロジックを単純化、セレクタの集中管理、ログ/スクショで原因追跡
- ログイン切れ
  - 方針：自動ログインはしない。検知して失敗として止め、運用で回復
- データが増えて肥大化
  - 方針：世代保持（暫定8世代）を軸に、必要になったら改善
- 保存先の扱い（プライバシー/セキュリティ）
  - 方針：暗号化は必須にしないが、アクセス権が管理できる保存先に限定する（共有や意図しない同期先は避ける）

—

## 10. 文書の分担（置き場）
- 判断基準：`MANIFEST.md`
- 実行ルール：`AGENTS.md`
- 縦切り：
  - `docs/vertical-slice-thin.md`
  - `docs/vertical-slice-standard.md`
- トラブル：`docs/troubleshooting.md`
- 意思決定の経緯：`docs/adr/`（必要になったら導入）

—

## 11. 実行時依存の宣言方針
- このリポジトリの実行時依存は **`pyproject.toml` と `uv.lock` に固定して宣言する**
- `uv run --with ...` は一時検証用途に限定し、通常運用（ローカル/CI）の前提にはしない
- Playwright 本体（Python パッケージ）は実行時依存として lock に含める
- ブラウザバイナリ（Chromium）は環境準備として `playwright install chromium` で導入する
- 依存追加/更新/削除時は lock を更新し、`uv lock --check` と `uv sync --locked` で整合性を確認する
