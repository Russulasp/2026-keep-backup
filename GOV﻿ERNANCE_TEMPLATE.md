# この設計雛形の位置づけ

- 本文書は、AIを用いたプロジェクト開発の判断基準と運用方針のテンプレートである
- 本文書の内容をもとに、AI によりレポジトリ内に `MANIFEST.md` と `AGENTS.md` を作る想定である
- 最終決定（仕様・優先度・可否判断）は常に人間が行う
- 本文書の読者は人間であり、本文書は「人間が AI をどう運用するか」を定める

—

# 原則（不変）

## 1. 判断基準は `MANIFEST.md` に集約する

- 迷ったときに参照すべき一次情報は `MANIFEST.md` とする
- `MANIFEST.md` には少なくとも以下を含める
  - 目的 / 非目的
  - 前提 / 制約
  - 実装したい機能 / 実装しないこと（スコープ外）
  - 最短成功パス（第1段階で必ず通す入口）
- 実装方針や可否判断に迷った場合は、コードやプロンプトより先に `MANIFEST.md` を確認・更新する
- `MANIFEST.md` は頻繁に変えず、変更理由を説明できる場合にのみ更新する

## 2. 実行ルールは `AGENTS.md` に寄せる

- 実行上のルール（実行入口、テスト、CI、禁止事項など）は `AGENTS.md` にまとめる
- `AGENTS.md` は `MANIFEST.md` を上書きしない（実行手引きに限定する）
- `AGENTS.md` には `MANIFEST.md` を判断基準として参照する旨を記述する

## 3. 意思決定の経緯は ADR に逃がす

- 「なぜそうしたか」を残す必要がある場合は ADR に記載する
- ADR は判断基準の補助であり、運用を直接置き換えるものではない

## 4. 判断基準と実装を分離する

- `MANIFEST.md` / `AGENTS.md` を編集するステップでは、コードや他ファイルを編集しない
- コードを編集するステップでは、`MANIFEST.md` / `AGENTS.md` を編集しない

## 5. AI の行動は判断基準に拘束する

- AI が不明点に遭遇した場合は推測で進めず、質問・代案提示に切り替える
- AI の裁量は「実装手順や分割」に限定し、「判断基準」は `MANIFEST.md` に従わせる

—

# 運用ルール（準不変）

## リポジトリに含めるもの（汎用）

- `.editorconfig` / `LICENSE` / `README` / `.gitignore` / `.env.example` はなるべく含める

## テスト運用

- テストは煩雑にならない程度に整備し、目的に応じて最小限にする（スモーク/ユニット/結合）
- E2E が必要な場合は、CI はスモークのみ自動、E2E は手動トリガーとする（特に初回は手動前提）
- データ系の処理は決定性を最重要視し、必要に応じて seed 固定、タイムゾーン固定、外部 API/外部ファイルのモック/フリーズ、fixture 作成を行う

## 依存関係管理

- 依存関係の正は依存定義ファイルとする（例：`pyproject.toml` / `package.json`）
- 依存定義ファイルを変更した場合は lock を更新し、整合性の確認手順は必須とする

### Python

- 依存追加・削除・更新は `uv add` / `uv remove` / `uv lock` 経由に限定する
- `pyproject.toml` を手で編集した場合は例外扱いとし、必ず `uv lock` を実行する
- `pyproject.toml` と `uv.lock` の整合性は常に取る

### Node.js（使う場合）

- Node のバージョン固定と lockfile 管理を厳密に行う

### CI（可能なら）

- 「依存定義ファイルが変更されているのに lock が更新されていない」状態を検知して失敗させる

## CI の狙いと入口

- CI は「ローカルでは動くが本番ビルドで失敗する」を防ぐため、build を確認する
- CI はローカルと同じ入口を呼ぶだけに寄せ、CI 専用の手順を増やさない

## Codex Cloud 固有の運用

- セットアップ/メンテナンススクリプトは段階的に整備する（最初は最小限）
- セットアップ/メンテナンススクリプトの役割
  - setup: 初回や起動直後に必要な準備（例：依存導入、必要ファイル生成、短命シークレットの受け渡し）
  - maintenance: 継続的な整備（例：キャッシュ整理、更新、点検）を必要になった段階で足す
- 秘密情報が必要な処理は setup に寄せる（setup 時のみ短命ファイルで渡される前提）

—

# 手順（可変）

## 事前準備（人間が用意する情報）

- プロジェクト名を決め、プロジェクトの規模に応じてGoogle Keep / ChatGPT Project / GitHub Repository / google document等(追加でgithub project、google spreadsheet、google drive、google todo)に専用の空間を準備する

- 以下の内容を中心に、AI にプロジェクトについて説明し、その推敲を受ける
  - やりたいこと
  - 利用シーン
  - 入出力
  - 制約（OS、ネットワーク、ログイン、秘密情報、期限、使える API、データサイズ感）
  - 非目的
  - 備考（メモでよい。清書は後で AI に作らせる）
- とりあえずやりたいことと、将来的にやりたいこと等レベルが異なることになると思う

- プロンプト例
  - 以下は、わたしのプロジェクトの趣旨を雑多にかいて表したものである。これのブラッシュアップを図る。まず、私に質問すべきことを質問して、その後私の回答を元に推敲版を作って。粒度としては、細かいコードまで書くのではなく、どういう技術スタックをどう使うとか、それくらいにして。また、今回やりたいことと、それが済んでから余裕があればやりたいことがあるだろうから、それらをうまく区別してまとめて欲しい。なお、markdown形式で出力して。
- 教えてくれたプロジェクト趣旨について、評価して欲しい。どの点をどうすれば良いとか、番号月リストで教えて。後のステップで、番号を指定して修正してもらうつもり。


## 仕様ドラフト（コードは触らん）

- メモを 目的 / 非目的 / 入出力 / 想定ユーザ / 制約 / リスクと対策 / 不明点 に整形する
- ただし、既にAIかいい感じの形式にしてたら、そのままで良い
- 不明点は解決するもよし、まてそのままにしてAIの裁量に任せるもよし
- 人間が納得できるまで修正する

## 最初のディスカッション（第1段階に入る前）

- 「環境 → 縦切り 1 本」までの作業計画を固める
- 既存のドラフトに下に続けて、縦切り一本の見通しというテーマで続きを書く
- 縦切りにも2種類必要だろう。薄い縦切りと標準的な縦切り
- 薄い縦切りプロンプト:さて、続けて##のレベルの見出しで、薄い縦切り一本分の見通しというテーマで続きを書きたい。プロジェクトの趣旨を踏まえ、十分実践的であり、必要最低限のポイントを抑えているものを教えて欲しい。私が求めている仕様を全て満たすのではなく、最初から最後までの最低限の動作に必要な部分のみ拾い上げ、それをできるだけ単純なロジックでまとめあげるものとして欲しい。なお、後のステップで標準的な縦切りについても相談するつもりであり、今回棄却する箇所があることについては悩まなくて良い。出力は##薄い縦切り一本分の見通し、のmdだけで、コードブロックで教えて。
- 標準的な縦切りプロンプト:プロジェクトの趣旨及び先ほどの薄い縦切り一本分の見通しを参考に、続けて標準的な縦切りについて、書いて欲しい。出力は##標準的な縦切り一本分の見通し、のmdだけで、コードブロックで教えて。
- 薄切り一本と標準縦切り一本は、別途google keepにメモっておき、後で、docs/vertical-slice-thin.md と docs/vertical-slice-standard.mdに貼り付ける

- 実行可能性が怪しい場合は、必要に応じてネット検索で最新の知見を一度確認する
- 以上を ChatGPT で実施し、その後レポジトリ上に `CONCEPT.md` を作る

## 3. 第1段階：環境と「動いた」を作る

- この時点でGOV﻿ERNANCE_TEMPLATE.md をレポジトリに作っておく
- `MANIFEST.md` と `AGENTS.md` を作る（判断基準と実行ルールを確定する）
- プロンプト例: 下記の、GOV﻿ERNANCE_TEMPLATE.md と CONCEPT.md を参考に、`MANIFEST.md` と `AGENTS.md` を作り、それぞれmdのコードブロックとして出力して。それらのファイルの趣旨はGOV﻿ERNANCE_TEMPLATE.mdに記載しているため、それを参照して欲しい。ざっくりいうと、プロジェクトに対して、MANIFEST は憲法、AGENTS.md はその施行規則のイメージ。その他必要であれば、少数のドキュメント（mdファイル）を策定して良い。docs/troubleshooting.mdはあっても良い。

GOV﻿ERNANCE_TEMPLATE.md:


CONCEPT.md:

- さて、この段階でレポジトリに、　　　　GOV﻿ERNANCE_TEMPLATE.md 、CONCEPT.md 、`MANIFEST.md` 、 `AGENTS.md` 、docs/＊、を、準備する。
- さらに、その内容を Codex にも評価させる
- プロンプト例:今のレポジトリについて、GOV﻿ERNANCE_TEMPLATE.md 、CONCEPT.md を元に、`MANIFEST.md` 、 `AGENTS.md` 、docs/＊.mdを、作成した。これを評価して欲しい。なお後々、GOV﻿ERNANCE_TEMPLATE.md 、CONCEPT.mdを削除し、レポジトリには`MANIFEST.md` 、 `AGENTS.md` 、docs/＊.mdを残す予定であり、これらを元にプロジェクトを、進めていく。なお、MANIFEST.md` はプロジェクトの憲法、 `AGENTS.md` の施工規則、docs/＊.mdはその他文書のイメージであり、ただし厳密にこの通りでなくても良い。あくまでイメージ。また改善点がある時は、番号付きリストで提案して欲しい。それを元に後のステップでAIに修正をお願いする予定である。
- コピペ用、  GOV﻿ERNANCE_TEMPLATE.md CONCEPT.md MANIFEST.md AGENTS.md docs/vertical-slice-thin.md   docs/vertical-slice-standard.md  docs/troubleshooting.md
- 次に、最低限のレポジトリを作る（環境固定と入口を優先する）
- プロンプト例: このレポジトリについて、最低限の構成を作って。まだ動くものは作らなくて良い。それっぽくhello worldを出力するものでも構わない
- 次に、最短成功パスの「縦切り 1 本」を作る（成功パスのみでよい）
- プロンプト例: 今のレポジトリについて、縦切り一本分を作って。

- 次に、第1段階の終わりにスモークを通し、「動いた」を再現可能にする
- プロンプト例: スモークテストを通して。

## 4. 第2段階：CI を薄く導入する

- CI はローカルと同じ入口を呼ぶだけに寄せる
- lock 不整合で落とす（可能なら）
- build が通ることを確認する
- プロンプト例: CIを薄く導入して

## 5. 段階的拡張

- 入口（make）/ 再現性（lock/環境固定）/ 最短成功パスを壊さない範囲で厚くする
- 追加は 1 回で盛りすぎず、「1テーマずつ」増やす
- プロンプト例: 以下の⚫︎⚫︎の機能を追加して。ただし既存のファイルの良いところを壊さない範囲で厚くすることに留意して。また判断に迷う場合は、コードを書かせず、仕様案を 2〜3案（メリデメ付き）で教えて。また `MANIFEST.md` や `AGENTS.md` を編集する方が良いと判断した場合は、それを修正して。その際はコードは編集しないで。

## 機能がまずまず充実してきたらやること

- 段階A：静的チェック（フォーマッタ/リンター/型チェック）
- 段階B：ユニットテスト（入口→中核→外部境界の順）
- 段階C：設定と実行の一貫性（設定の置き場所の一本化）
- 段階D：CI を少し強くする（条件追加は 1 つずつ）
- 段階E：E2E / 統合テスト（CI はスモーク自動、E2E は手動）
- 段階F：コンテナを「正」に寄せる（環境差が辛くなったら）

## 新機能実装等太らせる時のチェックリスト（例）

- 何を増やすか（目的）
- 何を増やさないか（非目的）
- 追加後も `make smoke` が通るか
- CI とローカルで同じ入口になっているか
- 依存定義と lock の整合性が保たれているか
- 失敗時に原因が追えるログ/エラーになっている

## 太らせ過ぎのサイン（例）

- `make smoke` が遅すぎて回らない
- 入口が増えて、人によって実行方法がバラける
- CI だけの手順が増えて、ローカルで再現できない
- 設定が複数箇所に散って、何が正か分からない


