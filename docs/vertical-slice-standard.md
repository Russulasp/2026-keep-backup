## 標準的な縦切り一本分の見通し

### 1. この一本で“通す”こと（標準の成功パス）
- Windowsで `backup_keep.bat` をダブルクリック
- WSL(Ubuntu) 上で Docker コンテナを起動
- コンテナ内の Playwright が **ログイン済みブラウザプロファイル**を使って Google Keep を開く
- **通常 / アーカイブ / ゴミ箱** をそれぞれ走査し、対象（Must/Should）をフルバックアップする
- `backups/YYYY-MM-DD/keep.json` を生成し、ログに件数・内訳・所要時間・成功/失敗を残して終了

> 薄い縦切りと違って、「全件」「状態別（通常/アーカイブ/ゴミ箱）」「最低限の失敗耐性」まで含めて“実用レベル”にする。

—

### 2. 取得対象（この縦切りで守る範囲）
- Must：本文テキスト＋最小メタ情報（識別子相当、タイトル相当、更新日時相当のいずれか）
- Should：アーカイブ、ゴミ箱
- Could（この縦切りでは基本やらない）：ラベル/色/リマインダー/添付など

—

### 3. 認証方針（堅牢性優先でシンプル）
- 自動ログインは実装しない
- 事前にログイン済みプロファイルを用意し、Playwrightはそれを使って起動する
- 実行時にログインが切れていたら、検知して失敗終了（ログに理由を残す）

—

### 4. 走査戦略（全件取得を成立させる最小ロジック）
- 画面の「ノート一覧」は遅延読み込みがある前提で、以下のどれかの単純な方式を採用する
  - **スクロールで追加読み込み**を繰り返し、一覧の増加が止まったら完了
- 重複を避けるために、各ノートに対して「キー」を1つ決めて収集済み判定する
  - 例：ノートのURL/ID相当、または（タイトル/先頭文/更新日時）の組み合わせ
- ノート詳細を開いて本文を取得し、一覧に戻る（または新規タブで開いて閉じる）
- 取得失敗（開けない/読めない）が一定数あっても、全体は止めずに続行して最後に集計する

—

### 5. 状態別の導線（通常 / アーカイブ / ゴミ箱）
- 取得を「状態」という軸で分け、同じロジックを使い回す
  - `run_scrape(status="normal")`
  - `run_scrape(status="archive")`
  - `run_scrape(status="trash")`
- 画面遷移は最小限の“入口だけ”を状態ごとに用意し、あとは共通化する

—

### 6. 出力（JSONを正とする：後工程に強い形）
- 出力先：`backups/YYYY-MM-DD/keep.json`
- 最低限入れる項目
  - `scraped_at`（実行日時）
  - `source`（環境情報：OS/WSL/Docker/Playwrightのバージョン相当が取れるなら）
  - `summary`（件数内訳：normal/archive/trash、errors件数）
  - `notes`（配列）
    - `status`（normal/archive/trash）
    - `body`（本文）
    - `title`（取れるなら）
    - `updated_at`（取れるなら）
    - `key`（重複判定に使ったキー）
- 取得不能なノートは `errors` に寄せる（最低限：status、原因、可能ならスクショパス）

—

### 7. ログ・デバッグ材料（標準として入れる）
- `logs/run_YYYY-MM-DD_HHMMSS.log` に以下を残す
  - 開始/終了時刻、所要時間
  - 対象範囲（normal/archive/trash）
  - 取得件数（内訳）
  - エラー件数（内訳）
  - 出力先
- 失敗や不安定さの原因追跡のために、最低限これだけは残す
  - 例外メッセージ
  - 失敗時スクリーンショット（`logs/artifacts/` などに保存）

—

### 8. 失敗耐性（やりすぎない標準）
- ノート単位の失敗はスキップして続行（全体停止しない）
- 画面読み込みや要素待ちには適切な待機（タイムアウト）を入れる
- ただしリトライは最小限（1回程度）にして、無限ループは避ける

—

### 9. 保持ポリシー（標準として最低限）
- 直近N世代保持（例：8世代）を自動で実施するか、少なくとも運用ルールとして明記する
- 削除は「日付フォルダ単位」で単純に行う（中身を解析して複雑にしない）

—

### 10. 完了条件（この縦切りで“実用”と言える線）
- `backup_keep.bat` 一発で最後まで走る
- `keep.json` に normal/archive/trash のデータが入り、件数内訳がログと一致する
- 一部エラーがあっても、全体としてバックアップ成果物が残る
- ログを見れば「何がどこまで取れたか」「どこで失敗したか」が分かる