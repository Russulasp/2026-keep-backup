name: notify-secrets-check

on:
  workflow_dispatch:

jobs:
  verify-notify-secrets:
    runs-on: ubuntu-latest
    steps:
      # This workflow only validates notification-related secrets and SMTP connectivity.
      - name: Validate required secrets (safe metadata only)
        shell: bash
        env:
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          NOTIFY_EMAIL: ${{ secrets.NOTIFY_EMAIL }}
        run: |
          set -euo pipefail

          # Always mask secret values; never print their content.
          echo "::add-mask::$SMTP_USERNAME"
          echo "::add-mask::$SMTP_PASSWORD"
          echo "::add-mask::$NOTIFY_EMAIL"

          fail=0
          for name in SMTP_USERNAME SMTP_PASSWORD NOTIFY_EMAIL; do
            value="${!name}"
            if [ -z "$value" ]; then
              state="missing_or_empty"
              length=0
            else
              state="present"
              length=${#value}
            fi

            # Detect actual line breaks only. `grep -q $'\n'` is a false-positive
            # because a newline in the pattern is treated as a pattern separator.
            if [[ "$value" == *$'\n'* || "$value" == *$'\r'* ]]; then
              has_newline=true
            else
              has_newline=false
            fi

            echo "${name}: state=${state} length=${length} has_newline=${has_newline}"

            if [ "$state" = "missing_or_empty" ]; then
              echo "::error::${name} is not set or is empty. Configure repository/environment secrets."
              fail=1
            fi
          done

          if [ "$fail" -ne 0 ]; then
            exit 1
          fi

      - name: Verify Gmail SMTP authentication
        env:
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
        run: |
          python - <<'PY'
          import os
          import smtplib
          import socket

          username = os.environ.get("SMTP_USERNAME", "")
          password = os.environ.get("SMTP_PASSWORD", "")

          try:
              with smtplib.SMTP_SSL("smtp.gmail.com", 465, timeout=20) as smtp:
                  smtp.login(username, password)
          except smtplib.SMTPAuthenticationError:
              raise SystemExit("SMTP authentication failed. Check SMTP_USERNAME/SMTP_PASSWORD validity (e.g., Gmail app password).")
          except (smtplib.SMTPException, OSError, socket.timeout) as exc:
              raise SystemExit(f"SMTP connectivity/auth check failed: {type(exc).__name__}.")

          print("SMTP authentication succeeded.")
          PY

      - name: Capture execution time (UTC)
        id: meta
        run: echo "executed_at=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> "$GITHUB_OUTPUT"

      - name: Send test notification email
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          to: ${{ secrets.NOTIFY_EMAIL }}
          from: keep-backup Actions <${{ secrets.SMTP_USERNAME }}>
          subject: >-
            [keep-backup] Notification secrets check passed
          body: |
            This is a test notification from the GitHub Actions workflow "notify-secrets-check".

            Result: SMTP authentication and send test succeeded.
            Workflow run URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            Executed at (UTC): ${{ steps.meta.outputs.executed_at }}
