<!— AGENTS.md —>

# keep-backup — AGENTS

## 0. この文書の役割
- このリポジトリの実行ルール（施行規則）
- 迷ったら `MANIFEST.md` を参照し、判断基準はそっちを優先する
- `AGENTS.md` は `MANIFEST.md` を上書きしない

—

## 1. 基本ルール（作業の分離）
- `MANIFEST.md` / `AGENTS.md` を編集するステップでは、コードや他ファイルを編集しない
- コードを編集するステップでは、`MANIFEST.md` / `AGENTS.md` を編集しない
- 「なぜそうしたか」を残す必要が出たら `docs/adr/` に書く

—

## 2. AI運用ルール（重要）
- 不明点に遭遇したら推測で突き進まない
  - 質問、もしくは代案（2〜3案）とメリデメを出す
- AIの裁量は「分割」「手順化」「実装の並べ方」に限定する
- 判断基準に関わる変更（スコープ/品質優先度/入口変更）は必ず `MANIFEST.md` の更新案を先に出す

—

## 3. 入口（実行コマンド）を増やさない
- ローカルもCIも同じ入口を呼ぶ方針（CI導入後も同じ）
- 入口は原則この3つだけに寄せる
  - `backup_keep.bat`（Windows入口）
  - `docker compose ...`（WSL入口）
  - `make smoke` 相当（導入するなら。無理なら `scripts/smoke.sh` でも可）

—

## 4. 実行導線（Windows → WSL → Docker）
- Windows：`backup_keep.bat` をダブルクリック
- WSL：プロジェクトディレクトリに移動して、Dockerの同一コマンドを呼ぶだけ
- Docker：Playwright実行環境を固定する

### ルール
- バッチにはロジックを入れない（呼び出しだけ）
- 設定値はWSL側の `.env` や設定ファイルに寄せる（バッチに埋めない）

—

## 5. 認証（ログイン）の運用
- 自動ログインは実装しない
- ログイン済みブラウザプロファイルを使う
- 実行時にログインが切れていたら、検知して失敗終了（ログに残す）
### CI 運用の例外方針（ダミー運用）
- CI ではログイン済みプロファイルを使わない（持ち込まない）
- CI では「ダミー（未ログイン想定）」で動作させ、**成功/失敗・取得件数・所要時間・出力先**の stdout 要約とログ出力を検証する
- 本番（PC/WSL/Docker）ではログイン済みプロファイルを使う前提で動かす
- CI でログインが必要になった場合は失敗終了とし、stdout の要約とログで検知できることを重視する

—

## 6. 出力とログ（最低限の統一）
- 出力先は固定（`MANIFEST.md` の通り）
  - `backups/YYYY-MM-DD/keep.json`
  - `logs/run_YYYY-MM-DD_HHMMSS.log`
- ログの最低項目
  - 開始/終了時刻、所要時間
  - 成功/失敗（終了コード）
  - 取得件数（状態別があるなら内訳）
  - 出力先
  - 失敗時の例外メッセージ
- 失敗追跡が辛くなったら、スクショ等の成果物を `logs/artifacts/` に追加する

—

## 7. テスト方針（重くしない）
- まずはスモーク（起動できる/出力ができる）を最優先
- E2Eは手動トリガー前提（最初はローカルのみでOK）
- UI依存のため、テストは「壊れたときに原因が追える」ことを重視する
- CI を導入する場合は、依存定義と lock の不整合を検知して失敗させる

—

## 8. 依存管理（言語未確定でも破綻しない書き方）
- 依存定義ファイルとlockが“正”
- 依存を変えたらlockを更新し、整合性確認を必須にする
- 採用スタックが確定したら、以下のどちらかに寄せる（両立させない）
  - Python系：`pyproject.toml` + lock（例：uv.lock）
    - 依存追加/削除/更新は `uv add` / `uv remove` / `uv lock` に寄せる
    - `pyproject.toml` を手で編集した場合は必ず `uv lock` を実行する
  - Node系：`package.json` + lock（package-lock / pnpm-lock / yarn.lock のいずれか）

> どの言語/ツールに寄せるかは判断基準の話なので、確定時は `MANIFEST.md` も更新する。

—

## 9. 変更の作法
- 変更は「1テーマずつ」
- 既存の入口とスモークを壊さない
- 入口を増やしたくなったら、まず「増やさずに済む案」を検討する

—

## 10. ドキュメントの更新ルール
- 縦切りの本文は `docs/vertical-slice-*.md` を正とする
- 重要な判断（例：ログイン方針、対象範囲、保持方針）が変わったら `MANIFEST.md` を更新する
- 実行手順やコマンドが変わったら `AGENTS.md` と `docs/runbook.md`（導入するなら）を更新する

—

## 11. スクリプト運用（必要になったら段階導入）
- setup/maintenance は「必要になった時点で」最小構成から導入する
  - setup: 初回や起動直後に必要な準備（依存導入、必要ファイル生成など）
  - maintenance: キャッシュ整理や更新、点検などの継続整備
- 秘密情報が必要な処理は setup に寄せ、短命の受け渡しで完結させる

—

## 12. リポジトリに含めるもの（汎用）
- `.editorconfig` / `LICENSE` / `README` / `.gitignore` / `.env.example` はなるべく含める
